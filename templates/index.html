<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload & Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- User Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background-color: #f5f5f5; border-bottom: 1px solid #ddd;">
        <h1 style="margin: 0; font-size: 24px;">The Analyst</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="username" style="font-weight: 600; color: #333;"></span>
            <a href="{{ url_for('logout') }}" style="padding: 8px 16px; background-color: #667eea; color: white; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background-color 0.2s;">Logout</a>
        </div>
    </div>

    <!-- Success Message Banner -->
    <div id="success-banner" style="display: none; padding: 15px 20px; background-color: #4caf50; color: white; text-align: center; font-weight: 600; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; animation: fadeInOut 5s ease-in-out;">
        File uploaded successfully!
    </div>

    <style>
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>

    <div style="padding: 20px;">
        <h2>Upload a File</h2>
        <form class="upload-form" action="/upload" method="POST" enctype="multipart/form-data">
            <input type="file" name="file" required>
            <button type="submit">Upload</button>
        </form>

        <hr>

        <h2>Files</h2>
        <section id="file-management">
            <div>
                <button id="refresh-files">Refresh files</button>
                <span id="active-file" style="margin-left:12px;font-weight:600;color:#333"></span>
            </div>
            <ul id="files-list"></ul>
        </section>

        <hr>

        <h2>Chat</h2>
        <div id="chat-container">
            <div id="messages">
                <!-- Messages will appear here -->
            </div>

            <form id="chat-form">
                <input id="chat-input" type="text" placeholder="Type a message..." autocomplete="off">
                <button id="chat-send" type="submit">Send</button>
            </form>
        </div>

        <div id="pagination-controls" style="display:none; margin-top:12px;">
            <button id="page-prev">Previous</button>
            <span id="page-info" style="margin:0 12px">Page 1 of 1</span>
            <button id="page-next">Next</button>
        </div>
    </div>

    <script>
        (function(){
            const form = document.getElementById('chat-form');
            const input = document.getElementById('chat-input');
            const messages = document.getElementById('messages');
            const filesList = document.getElementById('files-list');
            const refreshBtn = document.getElementById('refresh-files');
            const activeFileSpan = document.getElementById('active-file');
            const paginationControls = document.getElementById('pagination-controls');
            const pagePrev = document.getElementById('page-prev');
            const pageNext = document.getElementById('page-next');
            const pageInfo = document.getElementById('page-info');

            let lastPagination = null; // store last pagination metadata
            let activeFilename = null; // client-side active filename

            function appendMessage(text, cls, opts){
                const el = document.createElement('div');
                el.className = cls === 'user' ? 'msg-user' : 'msg-bot';
                if(opts && opts.html && cls === 'bot'){
                    el.innerHTML = text;
                } else {
                    el.textContent = text;
                }
                messages.appendChild(el);
                messages.scrollTop = messages.scrollHeight;
            }

            function setActiveFileLabel(name){
                activeFilename = name || null;
                if(name){
                    activeFileSpan.textContent = `Active: ${name}`;
                } else {
                    activeFileSpan.textContent = '';
                }
                // re-render files to update highlight
                // keep current list if available
                const items = Array.from(filesList.querySelectorAll('li')).map(li => li.getAttribute('data-fn'));
                if(items && items.length){
                    renderFiles(items);
                }
            }

            function renderFiles(list){
                filesList.innerHTML = '';
                list.forEach(fn => {
                    const li = document.createElement('li');
                    li.setAttribute('data-fn', fn);
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = fn;
                    const right = document.createElement('span');
                    right.style.display = 'flex';
                    right.style.gap = '6px';
                    
                    const selectBtn = document.createElement('button');
                    selectBtn.textContent = 'Select';
                    selectBtn.addEventListener('click', function(){
                        selectFile(fn);
                    });
                    right.appendChild(selectBtn);
                    
                    // Add Auto-Analyze button
                    const analyzeBtn = document.createElement('button');
                    analyzeBtn.textContent = 'Auto-Analyze';
                    analyzeBtn.style.backgroundColor = '#9c27b0';
                    analyzeBtn.style.color = 'white';
                    analyzeBtn.style.border = 'none';
                    analyzeBtn.style.padding = '6px 12px';
                    analyzeBtn.style.borderRadius = '4px';
                    analyzeBtn.style.cursor = 'pointer';
                    analyzeBtn.style.fontSize = '12px';
                    analyzeBtn.style.fontWeight = '600';
                    analyzeBtn.addEventListener('click', function(){
                        autoAnalyze(fn);
                    });
                    right.appendChild(analyzeBtn);
                    
                    li.appendChild(nameSpan);
                    li.appendChild(right);
                    if(activeFilename && activeFilename === fn){
                        li.classList.add('file-active');
                    }
                    filesList.appendChild(li);
                });
            }

            function fetchSession(){
                // Single API call combines files list, active file, and username
                return fetch('/api/v1/session')
                    .then(r => r.json())
                    .then(data => {
                        // Display username in header
                        if(data.username){
                            document.getElementById('username').textContent = `User: ${data.username}`;
                        }
                        if(Array.isArray(data.files)){
                            renderFiles(data.files);
                            // Set active file label from response
                            if(data.active_file){
                                setActiveFileLabel(data.active_file);
                            }
                        }
                        return data;
                    })
                    .catch(err => {
                        console.error('session API error', err);
                        return {files: [], active_file: null};
                    });
            }

            function selectFile(filename){
                fetch('/select_file', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({filename})
                })
                .then(r => r.json())
                .then(data => {
                    if(data && data.selected){
                        setActiveFileLabel(data.selected);
                        appendMessage(`Selected file: ${data.selected}`, 'bot');
                        // clear any pagination UI
                        lastPagination = null;
                        paginationControls.style.display = 'none';
                    } else if(data && data.error){
                        appendMessage(`Error: ${data.error}`, 'bot');
                    }
                })
                .catch(err => {
                    appendMessage('Error selecting file', 'bot');
                    console.error('select error', err);
                });
            }

            function autoAnalyze(filename){
                // Call the auto_analyze endpoint to get head, describe, and histogram
                fetch('/api/v1/auto_analyze', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({filename})
                })
                .then(r => r.json())
                .then(data => {
                    if(data && data.head){
                        // Display head analysis
                        appendMessage(`Analysis of ${filename} - Head:`, 'bot');
                        appendMessage(data.head, 'bot', {html: true});
                        
                        // Display describe analysis
                        appendMessage('Statistical Summary:', 'bot');
                        appendMessage(data.describe, 'bot', {html: true});
                        
                        // Display histogram if available
                        if(data.histogram){
                            appendMessage('Distribution Chart:', 'bot');
                            appendMessage(data.histogram, 'bot', {html: true});
                        }
                    } else if(data && data.error){
                        appendMessage(`Error: ${data.error}`, 'bot');
                    }
                })
                .catch(err => {
                    appendMessage('Auto-analyze failed', 'bot');
                    console.error('auto-analyze error', err);
                });
            }

            // Intercept upload form to upload via fetch and refresh files + auto-select
            const uploadForm = document.querySelector('.upload-form');
            uploadForm.addEventListener('submit', function(e){
                e.preventDefault();
                const fileInput = uploadForm.querySelector('input[type="file"]');
                if(!fileInput || !fileInput.files || fileInput.files.length === 0) return;
                const file = fileInput.files[0];
                const fd = new FormData();
                fd.append('file', file);
                fetch('/upload', { method: 'POST', body: fd })
                    .then(r => r.text())
                    .then(text => {
                        // Show success banner
                        const banner = document.getElementById('success-banner');
                        banner.style.display = 'block';
                        setTimeout(() => { banner.style.display = 'none'; }, 5000);
                        
                        // Refresh file list and auto-select
                        fetchSession();
                        setTimeout(() => selectFile(file.name), 300);
                        
                        // Clear file input
                        fileInput.value = '';
                    })
                    .catch(err => {
                        appendMessage('Upload failed', 'bot');
                        console.error('upload error', err);
                    });
            });

            form.addEventListener('submit', function(e){
                e.preventDefault();
                const value = input.value.trim();
                if(!value) return;
                appendMessage(value, 'user');
                input.value = '';
                input.focus();

                sendChat(value, {showUser:false});
            });

            function sendChat(message, opts){
                opts = opts || {};
                if(opts.showUser !== false){
                    appendMessage(message, 'user');
                }
                return fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                })
                .then(r => r.json())
                .then(data => {
                    if(data && data.response){
                        appendMessage(data.response, 'bot', {html:true});
                    }
                    if(data && data.pagination){
                        lastPagination = data.pagination;
                        pageInfo.textContent = `Page ${data.pagination.current_page} of ${data.pagination.total_pages}`;
                        paginationControls.style.display = 'block';
                        pagePrev.disabled = data.pagination.current_page <= 1;
                        pageNext.disabled = data.pagination.current_page >= data.pagination.total_pages;
                    } else {
                        lastPagination = null;
                        paginationControls.style.display = 'none';
                    }
                    return data;
                })
                .catch(err => {
                    appendMessage('Error: could not reach server', 'bot');
                    console.error('chat error', err);
                });
            }

            // Allow Enter to send
            input.addEventListener('keydown', function(e){
                if(e.key === 'Enter' && !e.shiftKey){
                    e.preventDefault();
                    form.dispatchEvent(new Event('submit', {cancelable:true, bubbles:true}));
                }
            });

            // pagination buttons
            pagePrev.addEventListener('click', function(){
                if(!lastPagination) return;
                const cur = lastPagination.current_page || 1;
                const prev = Math.max(1, cur - 1);
                sendChat(`show page ${prev}`, {showUser:true});
            });
            pageNext.addEventListener('click', function(){
                if(!lastPagination) return;
                const cur = lastPagination.current_page || 1;
                const next = Math.min(lastPagination.total_pages || cur, cur + 1);
                sendChat(`show page ${next}`, {showUser:true});
            });

            // wire refresh and initial load
            refreshBtn.addEventListener('click', fetchSession);
            fetchSession();
        })();
    </script>
</body>
</html>
